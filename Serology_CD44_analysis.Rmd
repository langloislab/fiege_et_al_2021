---
title: "Serology CD44 Analysis-20Jul21"
author: "Frances Shepherd"
date: "7/20/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warnings = FALSE)
```


```{r Read data and MDS}
library(dplyr)
library(ggplot2)
library(factoextra)
library(FactoMineR)

#Set seed for reproducibility
set.seed(1360)
data <- read.csv("dirty_mouse_cd44_serology_data.csv", header = T, stringsAsFactors = FALSE)

#Change mouse type to factor
data$Mouse_type <- as.factor(data$Mouse_type)


#Convert the Positive and Equivalent values to number 1 and negative values as 0, convert to numeric type.
pathogen.cols <- 6:24 #Define which column indices contain serology data

data[, c(pathogen.cols)] <- sapply(data[, c(pathogen.cols)], function(x) gsub("Pos|Equiv","1",x)) #Change "positive" or "equivalent" to 1
data[, c(pathogen.cols)] <- sapply(data[, c(pathogen.cols)], function(x) gsub("Neg", "0", x)) #Change "negative" to 0
data[, c(pathogen.cols)] <- sapply(data[, c(pathogen.cols)], as.numeric) #Change the data type to numeric for analysis

#subset data to get rid of the pet store mouse serology
coh <- data[-grep("Petstore", data$Mouse_type), ] %>%
  droplevels()

#Extract the columns related to the presence/absence serology data
serology <- coh[,c(pathogen.cols)]

#Calculate distance matrix of samples
serology.dist <- dist(serology, method = "binary")

#Perform multidimentional scaling to represent distance matrix in an X-Y axis
mds <- cmdscale(serology.dist, eig = TRUE, k = 2)

#Create new dataframe for graphing
graph_data <- as.data.frame(mds$points) %>% #Extract mds coordinates
  bind_cols(CD44 = coh$D60_percent_CD44) %>% #add CD44 data
  bind_cols(cage = coh$Cage) %>% #Add cage
  bind_cols(mouse_type = coh$Mouse_type) #Add mouse type (balb/c, b6, fomite)

coh[,c(pathogen.cols)] <- lapply(coh[,c(pathogen.cols)], factor) #Convert serology data to factor type
drop.unused.variables <- function(x){ #Function for removing serology data where all mice are positive or negative
  if (nlevels(x) == 2) {
    return(x)
  }
}

coh[pathogen.cols] <- lapply(coh[pathogen.cols], drop.unused.variables) #Apply defined function to the columns that contain serology data. Columns that 

combos <- as.data.frame(plyr::count(coh[, 6:ncol(coh)]))
print(paste("There are", nrow(combos), "unique pathogen combinations in this dataset."))
```

### MDS:

MDS plot of serology data. Distances represent similarity in past exposure to 18 pathogens. Jittering of points has been added so you can see all the points, since many mice had identical serological profiles.
First, colored by %CD44 positivity of CD8 T cells:

```{r MDS plot all data-serology vs CD44}
ggplot(data = graph_data, aes(x = V1, y = V2, color=CD44)) +
  geom_jitter(width = 0.02, height = 0.02, size = 1, aes(color = CD44)) +
  scale_color_gradient(name = "%CD44", low = "yellow", high = "red")+
  labs(title = "Serology vs CD44 MDS",
       subtitle = "Contains B6 cohoused, Balb/c cohoused, and B6 male fomite\nDistance represents similarity based on serology profile")+
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        #strip.background = element_rect(color = "black", size=0.5, fill = "white"),
        axis.line = element_line(colour = "black"))
```


Now, colored by type of mouse:

```{r MDS plot all data-mouse type vs serology}
ggplot(data = graph_data, aes(x = V1, y = V2)) +
  geom_jitter(width = 0.02, height = 0.02, size = 1, aes(color = mouse_type)) +
  scale_color_manual(name = "mouse_type", values = c("yellow", "red", "blue", "purple"))+
  labs(title = "Serology vs mouse type MDS",
       subtitle = "Contains B6 cohoused, Balb/c cohoused, and B6 male fomite\nDistance represents similarity based on serology profile")+
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        #strip.background = element_rect(color = "black", size=0.5, fill = "white"),
        axis.line = element_line(colour = "black"))
```


### FAMD

Percent variance explained by each component generated by FAMD:
```{r FAMD complete cases only}
#Grab the columns related to serology data and CD44%. These variables will be used as input for the FAMD analysis.
coh_famd <- coh[,c(5:ncol(coh))]

#Perform FAMD
res.famd <- FAMD(coh_famd, graph = FALSE)
res.famd$eig
```

Looking at how the different variables contribute to the principle components:
```{r FAMD variables vs principle components-complete cases only}
fviz_famd_var(res.famd, repel = TRUE)+
  labs(title = "FAMD of Dirty Mice",
       subtitle = "Contribution of serology (positive/negative) and %CD44\nto principle component inertias",
       caption = "Dots closer to axes indicate the variable contributes to the principle component")#Plot of variables and their contributions to the axes
```

```{r FAMD variable contributions- complete cases only}
fviz_contrib(res.famd, "var", axes = 1)
fviz_contrib(res.famd, "var", axes = 2)
fviz_contrib(res.famd, "var", axes = 3)
fviz_contrib(res.famd, "var", axes = 4)
fviz_contrib(res.famd, "var", axes = 5)
```

In the two principle components that explain the majority of variance in this dataset, CD44% contributes less or close to what we'd expect if all variables contributed equally (red dotted line).